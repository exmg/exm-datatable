<link rel="import" href="../polymer/polymer.html">

<!--
`exm-data-helper` is helper element that facilitates sorting and paging on local data sets.

```html
<iron-ajax url="data/contacts.json" last-response="{{rawItems}}" auto></iron-ajax>

<exm-data-helper
  raw-items="[[rawItems]]"
  items="{{items}}"
  page-index="[[pageIndex]]"
  page-size="[[pageSize]]"
  sorted="[[sorted]]"
  sort-direction="[[sortDirection]]"
  total-items="{{totalItems}}">
</exm-data-helper>

<table is="exm-datatable">
  <thead is="exm-thead" sorted="{{sorted}}" sort-direction="{{sortDirection}}">
    <tr>
      <th sortable="name">Name</th>
      <th sortable="email">Email</th>
      <th sortable="phone">Phone</th>
    </tr>
  </thead>
  <tbody is="exm-tbody" items='[[items]]'>
    <template id="tbody">
      <tr>
        <td>[[item.name]]</td>
        <td>[[item.email]]</td>
        <td>[[item.phone]]</td>
      </tr>
    </template>
  </tbody>
</table>

<exm-paging
  total-items="[[totalItems]]"
  page-index="{{pageIndex}}"
  page-size="{{pageSize}}">
</exm-paging>
```

@element exm-data-helper
@demo demo/index.html
-->

<dom-module id="exm-data-helper">
  <template></template>
  <script>
  Polymer({
    is: 'exm-data-helper',
    properties: {

      /**
       * Raw item list
       */
      rawItems: {
        type: Array
      },

      /**
       * Returnes a page of the sorted items
       */
      items: {
        type: Array,
        notify: true
      },

      /**
      * Returns the total length of the raw list that will be used in the exm-paging
      * as indication on how much pages there are available.
      */
      totalItems: {
        notify: true,
        type: Number,
        computed: '_computeLength(rawItems.*)'
      },

      /**
      * This property can be used to change the current visible items page
      */
      pageIndex: {
        type: Number,
        value: 0
      },

      /**
      * Set the page size of the exposed item list
      */
      pageSize: {
        type: Number,
        value: 10
      },

      /**
      * An string containing the column sort key
      */
      sorted: String,

      /**
      * An string containing 'ASC' or 'DESC' to indicate the sorting direction
      */
      sortDirection: String

    },
    observers: [
      '_sortChanged(sorted,sortDirection)',
      '_ramItemsChanged(rawItems.*)',
      '_pageChanged(pageIndex, pageSize)'
    ],
    _doSort: false,
    _sortChanged: function(sorted, sortDirection) {
      this._doSort = true;
      this._updatePage();
    },
    _computeLength: function(rawItems) {
      return this.rawItems.length;
    },
    _ramItemsChanged: function() {
      this._doSort = true;
      this._updatePage();
    },
    _pageChanged: function(pageIndex, pageSize) {
      this._updatePage();
    },
    _updatePage: function() {

      if(this.rawItems === undefined) {
        return;
      }
      /* Make sure to always start with same array to ensure consistency in sorting results */
      var workArray = this.rawItems.slice();
      var start = (this.pageIndex * this.pageSize);

      if(this._doSort && this.sorted) {
        var lookupItemByPath = function(item, path) {
          var parts = path.split(".");
          if (parts.length === 1){
            return item[parts[0]];
          }
          return lookupItemByPath(item[parts[0]], parts.slice(1).join("."));
        };

        workArray.sort(function(a, b) {
          var fieldA = lookupItemByPath(a, this.sorted);
          var fieldB = lookupItemByPath(b, this.sorted);
          if(typeof fieldA === 'number' || typeof fieldA === 'boolean') {
            return this.sortDirection === 'ASC' ? fieldA - fieldB : fieldB - fieldA;
          } else {
            fieldA = fieldA.toLowerCase();
            fieldB = fieldB.toLowerCase();
            if (fieldA < fieldB) {
              return this.sortDirection === 'ASC' ? -1 : 1;
            }
            if (fieldA > fieldB) {
              return this.sortDirection === 'ASC' ? 1 : -1;
            }
          }
          return 0;
        }.bind(this));

        this._doSort = false;
      }

      this.set('items', []);
      for(var i = start; i < start + this.pageSize; i++) {
        if(workArray[i] !== undefined) {
          this.push('items', workArray[i]);
        }
      }
    }
  });
  </script>
</dom-module>
