<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="data-provider">
	<template>
		<style></style>
		<iron-ajax url="demo/data/contacts.json" last-response="{{_rawItems}}" auto></iron-ajax>
	</template>

	<script>
	Polymer({
		is: 'data-provider',
		properties: {

			/**
			* Set the header title of the table
			*/
			itemsToGenerate: {
				type: Number,
				value: 24
			},

			/**
			* Set the header title of the table
			*/
			totalItems: {
				notify: true,
				type: Number,
				computed: '_computeLength(_rawItems.*)'
			},

			/**
			 * dummy items 
			 */
			items: {
				type: Array,
                notify: true
			},

			/**
            * This property can be used to change the current visible items page
            */
            pageIndex: {
                type: Number,
                value: 0
            },

            /**
            * Set the page size of the exposed item list
            */
            pageSize: {
                type: Number,
                value: 10
            },

			/**
			 * dummy items unpaged list 
			 */
			_rawItems: {
				type: Array,
			},

			/**
			* An string containing the column sort key
			*/
			sorted: String,
			
			/**
			* An string containing 'ASC' or 'DESC' to indicate the sorting direction
			*/
			sortDirection: String

		},
        observers: [
			'_sortChanged(sorted,sortDirection)',
            '_ramItemsChanged(_rawItems)',
			'_pageChanged(pageIndex, pageSize, itemsToGenerate)'
        ],
		doSort: false,
		addItem: function() {
			this.push('_rawItems', {"name":"Mark","email": "mark@test.com"});
		},
		deleteItem: function(item) {
			this.splice('_rawItems', this._rawItems.indexOf(item), 1);
			this._updatePage();
		},
		_sortChanged: function(sorted, sortDirection) {
			this.doSort = true;
			this._updatePage();
		},	
		_computeLength: function(_rawItems) {
			return this._rawItems.length;
		},
        _ramItemsChanged: function(_rawItems) {
		   this._updatePage();
        },
		_pageChanged: function(pageIndex, pageSize) {
			this._updatePage();
		},
		_updatePage: function() {

			if(this._rawItems === undefined) {
				return;
			}
			var start = (this.pageIndex * this.pageSize);

			if(this.doSort && this.sorted) {
				var lookupItemByPath = function(item, path) {
					var parts = path.split(".");
					if (parts.length === 1){
						return item[parts[0]];
					}
					return lookupItemByPath(item[parts[0]], parts.slice(1).join("."));
				};
			
				this._rawItems.sort(function(a, b) {
					var fieldA = lookupItemByPath(a, this.sorted);
					var fieldB = lookupItemByPath(b, this.sorted);
					if(typeof fieldA === 'number' || typeof fieldA === 'boolean') {
						return this.sortDirection === 'ASC' ? fieldA - fieldB : fieldB - fieldA;
					} else {
						fieldA = fieldA.toLowerCase();
						fieldB = fieldB.toLowerCase();
						if (fieldA < fieldB) {
							return this.sortDirection === 'ASC' ? -1 : 1;
						}
						if (fieldA > fieldB) {
							return this.sortDirection === 'ASC' ? 1 : -1;
						}
					}
					return 0;
				}.bind(this));

				this.doSort = false;
			}

			this.set('items', []);
			for(var i = start; i < start + this.pageSize; i++) {
				if(this._rawItems[i] !== undefined) {
					this.push('items', this._rawItems[i]);
				}
			}
		}
	});
	</script>
</dom-module>
